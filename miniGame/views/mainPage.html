<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Testovací Aplikace</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="top-bar">
   
         <div id="activePlayers"><%- include('_activePlayers.html') %></div>

    <a href="/logout" class="btn">Odhlásit se</a>
  </header>

  <main class="main-content">
    <div id="gameRequestSection">
      <select id="activePlayersSelect">
        <option value="">-- Select active friend to play --</option>
        <% players.forEach(function(player) { %>
          <option value="<%= player.id %>"><%= player.username %></option>
        <% }); %>
      </select>
      <button id="requestGameBtn">Play</button>
    </div>
    <a href="/friendsPage" class="btn">Friends</a>
  </main>

  <script>
   const ws = new WebSocket("ws://localhost:3000/ws")
 
   ws.addEventListener("message", (event) => {
    console.log('received event', event.data)
    const {type, html} = JSON.parse(event.data)
    if (type === "activePlayers") {
      const el = document.getElementById("activePlayers")
      el.innerHTML = html
      // Also update the select box
      const select = document.getElementById("activePlayersSelect");
      if (select) {
        // Remove all except the first option
        while (select.options.length > 1) select.remove(1);
        // Parse html to get usernames and ids
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        tempDiv.querySelectorAll('.player').forEach(playerDiv => {
          const username = playerDiv.querySelector('.username').textContent;
          const id = playerDiv.getAttribute('title');
          const option = document.createElement('option');
          option.value = id;
          option.textContent = username;
          select.appendChild(option);
        });
      }
    }  
   })

   document.getElementById('requestGameBtn').onclick = async function() {
     const select = document.getElementById('activePlayersSelect');
     const playerId = select.value;
     if (!playerId) return alert('Please select a player!');
     // Send request to server to start game
     const res = await fetch('/requestGame', {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify({ opponentId: playerId })
     });
     if (res.ok) {
       window.location.href = '/clickOnSignalGame';
     } else {
       alert('Could not send game request.');
     }
   }
  </script>
</body>
</html>
